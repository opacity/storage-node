sudo: required

language: go

go:
 - "1.11.4"

branches:
  only:
  - master
  - main

env:
  global:
  - DOCKER_COMPOSE_VERSION=1.18.0
  - GO111MODULE=on
  - DISPLAY_NAME=travisBuild
  - SLACK_DEBUG_URL=""
  - DISABLE_DB_CONN=false
  - PROD_DATABASE_URL="root:secret@tcp(db:3306)/test?parseTime=true&multiStatements=true&readTimeout=1s"
  - TEST_DATABASE_URL="root:secret@tcp(db:3306)/test?parseTime=true&multiStatements=true&readTimeout=1s"
  # ETH_NODE_URL
  - secure: "M0bGhm0+J3rVo9KU26VAueVF8GCFV7JWyRiPDw+3Z6imCYlU2nqB08+ylD6+ObuyWPM4p5nXez2VqcdcSlLpye4t5O/l27mlA/AK09/L6PnIsTMHVD21gHYjlcktp9MDnZBFX+JH2xSryUyCCLzAzo8JYLZ6B1WNt1XsNboETog9d4ZLnSraYljCEUNGbTjSWzxbwp+xNvxlUYV9z/xHml6sKIkS7inh3RF0+jJTwGWMjCaCHv7aZaKimxJgr88fmLuZbTn4c/VW6QuWQa+fS2A3FLkMoKTNH+VBtXiHlNrZceliM+kEzZx00q31ycychTHj/VjxA5NeCNRvDds7PA3mmpZUhhoz7LzWmLTQxJQttH7GaIgd0EmhPw5svnYYGF6FrcG2o6hBYRB+kDh7YdaGIQtnX+Z384CwPX3094syGCN+wNAi1iqGZ1xwoymEUhX3gCBVpYW8nIU3Q4cES2XLWa6S+v+8O+5SzuCxobBIPFGWlLj1+VRDhmRnu2YBXp0EXWixwxhV5FyBUpIySSx8HhmeDDiksaEux4794smaWyKCWO7m5IH3i+qOQF0bKJH23tEw0FLzdJg3ojCeQ1FURTXtjc26i99owSqCika/Rn5vDEIEfN1aNNAuvnTAs3cidgp+oZN+K4tfbLuLwF7lOUAz/FW0E0RKke8ekmQ="
  # AWS_ACCESS_KEY_ID
  - secure: "kzvaRIiJ8HcXhYBwOFOf/lsZW4bkK/B9E0HFJOjQcVdP/RkHqJ43jE26IVhT3c0fLQKVDD1wzi0/qyFml4KjAqlADWPtq0GqntKhXXQ3QMp/rBo382wS37f6r07URjbEcAQ6WkFNwDL6ie3zy3UxNk2rbXZ/8HJgiqR9z6r2A3SDT1sY14jon54MKdqvr0OEdEtQ16CLnZVfAKA5BAcqOEQoIZI3R1ips1OdkttIW7XBPTLxNHWCsLmKrED/7II+otIwDuZ/4XquR/Rza86TbqwdJ4xvqtqh3rCxYal+6xy4n0GsyJuaV6E3y+zX8+CJ6jFDnCI7CqTwvKUgvW3+TPBQeUvWIDfqwCWs1d9OE5sC1W1KQHsnOYH3KjqzzwKxZWfd2ccJCcLxXzNWacj7J9nq8Z4V92yYAhHQkWZvuwHdFffgPeAsRR2lMAIm6JgbOvc2o4nvu/AbStrl/V8Y2zfCRIPrC2RbQfX+MRA/lMaRoEyWmjhjfe42eSSQZzcCnoFw/Hff+91XTIZRoSo7CzNt9v+ASjlmWye4Vb+lnkK310lsxV2OGWmGiO8YeBhCWGfrrAAkz3MV9RKgMzWOkalmxVW9fJXc5wI+91UvHBLIdxwzS08qZVXNQBiQV0ndXgTHhg+PnNWa4wRld+SGY8XUu/gG2ROy3SspkGYeQ44="
  # AWS_SECRET_ACCESS_KEY
  - secure: "K1OoWSEvgnCO2GKxfq7G0SEfbPbNgXyP641Gk5l0kgUwQNJIvINkfxMd+p6z1bg3Ih02QfMEt4wDcxxRhrzAoYs17sJxf+zW9DA+SHO05TLMQntIDn7D4M+i07lHirZUiYQxXHODUiS9FxIMjyyp5YlGqeRYpFmtyoyX1L1HHN1MICYyAH1cLVmHOi3Jy9t48UL4rUtLhYaGrvW24f3ATEvKRF2JbbLJhlYgHYripAH8GRE9Rbedu8oBlumOd6DS2y8MwuQehZov/iALIPYmsBAnr8bRMqa+qTGMLFi0As42FlxA5VOx8S0g4YP/z3WbBaPNmI6wfJPXcCOz9UZEla2RDbZoVSxYA7YoZDa0J8scEhNRjbPRuY5FxdFCY90sOxq8hjtmc+M4nAwcMZ9fLUO92oML6vbJmK1crAFNbdqG0qkGSth4U+tDje9laL0Ny6Fp+wij250X378mUHegMRXOszGg7C+KZjf7zSXaLIoh7Vj+vrZRHSZejlfzgDHyOgydtchcIbrVywve0uEvwr/jpSpK6WCo03Pzd4VAzy5cT4LF684UTEvWWmh1GKW0V50D0A8Ctny8i0g4IkfCxyvsWSLs/l7tAEbwaXOxChg865AI1FtxL2P+y82nuYkEyp4v7FZZALjHIs4F3U4iW9NgXe01Vb812OL3Wewj64Q="
  # AWS_REGION
  - secure: "nNfqWcbClfD8VYWAUe6cYKb/OipzWN3voS64l0MVeybYDJ/yU7ghVq9RHnNco6syy2GzZRJqCY+ABD5QwH4YDcTNgcDO9LWi5h4CE0/74Av/OFoaoOiTpTcbVPcip1xaTKfjRaqKogogmuqqrHzhF9MYkDQFRLVUZTUi7yhNt56GuKl0lKWZDkNNeClj16Fzw41z2zkJgXrcXR+aBj11R/A0IbXE2snlbv6zkLHtYFK0+3DI+gMrvhYhUT9b8XdceRGl907X9vM4izcDFT02vQGDw/fIVsehYGVJ33JRSwAthNyI5EzcCv4iQRwV8VH3JPCkoG4tzfJ8rlzceinlwjeay15YfzOyC34kK6j+PdZ6cmkRm8/L4N+YqwxOeZEHYeLmo7DhxLrPtMlop2QCk3VsM7rBTd6X/HqPGjqT8D8ZrDa4zOooLM+TDJKMkp0b52UJ23b1bmA5AcvWYiBVNfWUyyqybpnnLQkByY7cYKP+2vmdFanIkszKescJTdEsoicfiq2HsBGC4A8vqGSecpmEiBiAD9jb3tqg4dEPDthbN3Bcy97ypqFIR1B2bRuCB1LGA7pjOx6zKu5AKidSpaq/9pcO9mWY/myF+g2CO0v+xydU8Dq9STL4pHI5sJDkUWCWaih5yX3PRM8UzlTsVQCixaTmxzSboESnmYiTxwY="
  # AWS_BUCKET_NAME
  - secure: "KXf1BZuunh9cqD9SL9fIEMVnPEGdS50KuhvVeKAXL5o6pRFjEVb6YHxJWuzuPwYCMML6QlahXoGoCG0OKP16KOx7xdHYND4QZlRNNBxC4dHBMamO77+mElcfO9ayVjtLw6UfUa1FtiNYoWvHBF+rK5N69HGi15/eOOddLvbooM8xPq6dNcL+nEVREzx7Lj1jvQmJ77JLKm/tR+17MqTITvG06CUK+X2C6atH0F5QJG2us5jnqPC/C8FN93vfVdzG0qR3aQUvZfw3+U+Qz0MYWXZyZ1f5YRdupa79FCMhgTFPBjM62mTIFFyQOwjwxwXwiQjsJKHB03ufL9oOscR0fhJZPjCh1henKspiftQgN38SFoa6rMj3xbDJKs3JYSH43+CmswH/BbGu9tIwgqsIrYMtnmkrFOK4soU3/YGqpQeW+LG9PkFDok7Pv6tvWe/gvIMNFueViMNFsd4e9TyPbpaSnmzhAv+SfHGF+glynFmevVLo6FiZvLngZU1HiEATHpPCqes63WJHO5jHuzHQYdFjSzun9WxCokoaAoqzHxt3eiacmPFPnBROflS88Jhiqmd7QWPb/1cq1I8UA3bCnDC3DZE9BsmkliotPLjSN3ZaWZ7ANZD9c2iUuoG7qAbWawtTK3kOWKkDeS/87EquWTfr+65Jnn9grU9JbW6Yyu4="
  # MAIN_WALLET_PRIVATE_KEY
  - secure: "aFsLs+iMpRMxjgDrA08k2mL16bX0r+V4CKIX/ONt+ASe4o8LD3IClhRz6EYTA5aMH2ub1qQf57Jqm5HLl3pGrLbefs47Bb2rcOKcJKZWgxszH6cdpESx4m4f6w9Zt36glnn7RFeMXZWOzF7MCtmMBQmQaD9/0trfFstDbKYf6EQbj+fT3UvVugtv9gEaOhYOQzGs07Y0coEitmlIeu0nDrC7xQdhNeMOwYm67lpQchS9GQnHbLMLq6BBiu2drTxTKZmoYYAgNeqTpA+rx6vu327Ajevl53cqxmpPs7k1HNJZSxkTUH2Zz7TmUaUBr28fV48IgMhC11lImXG5gmsgBxASVdZCAVyMV+LL2I/ZvIBvjon2sWcqnPhHj6bFwfLxluXSN31JfdZE1Q+SWOHwYDF1BOtuQvQxycqg2Q9uvn7G+tc9ptsSGdAFMi2vt4eXbzwQwdCy4r4EPx+H6iqgTzRhpoyt/nZVWM4P8QrtXHD0swZGYTLLoMTE4I4NkS1ulXyaiCFUxWEYk8BVKa2R6rm01SlTYz/cj+Gi+6k293/xnMAu9iheMBMAK2xOwIwFmacnFspFkSRd1eg/WTSWrV0EIR8IS4FWU+xl5geo12yyg85FHMy3DvUTawT5LjEHJq49AcMoa64I26p9w/jytE4HThjIeoPyoTPMNgZ1kGc="
  # MAIN_WALLET_ADDRESS
  - secure: "SDRw4DLmM1amavSAcxI45AsooVUw4Pz2qkiN1iYb+3DRK9ff+uI3Jsrx3CcUnY6gyuJzI7fZoI1AcivS639gv3OtEpBqDaZPJ7xMSOFdWCwrbpHGoTUmanboVhKc2fvXNKd2a5WtDvaN2KmrbLYhz8WB1NyGUcKYSVHwYVZpeesC6iXKTsDm6Hz0kVy4teVfBys2X0H8W7gf4VVS7vTU1vjH877lly3XOYrHRGgUESjibYFel2dbcvI2bMoyvj5JEL9hWd2gjnrQbeW3SvelKVhyXzsaKHGvQ5qofQz8TEq5Ghe2xl3jlJ/qAs3qrV/V+kgJ2PJPlRJda0U7GjyK/ltIY37Ist/uTgZ1hf40iO8ca0ySwY+hIyhETmb+VnEUIwvqXlULZC8SZCOn3nwADjHvvy/5TSCfePQAdKSzI1skKeXdtKkcegdcngRPIQJRktg6UlGc+Xl3sUopfVN70LxwEkHu60syA1WUvBGbkPXbHCrsMMv3guzlwzniyyCuUTYPRPsW6++301DPmhCD38RXuggrIXdHdOvwlslk3yqU0QJoj+s+5lE2XQ+lbQvonTsExgxTskHF+ftX9qpGysLOSn24UbiV1507jaMHEsJDebr5lSXCe3AUL9uQjmmHxq8t6xiyv8ihXOmbz7b1MrFF+BQeeU0Vo+i1B8mtt9M="
  # ENCRYPTION_KEY
  - secure: "iadH1I5VTBHM6b33v36yWimwAhilv/qX4s0MKOLp8X7g7SxV41k6tnrkjI+4oUf+DLAXR9nGbJB2vcaiOg5YNaVi0Hr7AeVkx5C34pmSqqocTaPqttjJVMeOzu6l4lWFMiFDdET+TrIinaic9un8AaZIBfKuVLrRUfD2S/rI5otmzxAInTKuJdPJ6sHMqpTDRXjnd4P0a22KNImPMtNbXD+kDPmMfiq+Pf2+ThpIFqzfl7EeTMN1p3bIuiXRIprIja/snXzDFuQfPALMEneED6eTW8wWeyZij4Y81Piypqygwsj16dp8CwvesmoXDrjrgG7R7ymENVo+uifxoQOzp+LvHBZXSzNb4cS0ujlM/p6xIM063oojJc0qNPQFuUVZ+6C1A6CETg8NU48euJ+IkwOIMev24vg1qsVd28g35f0dtXc3zTSYpt1cJB99ZjwC6TwyXxsA8WjS0Xf6ZQomXyacrCxf5ujz5o+w/ckpffNRn0TzHcmEje43/ecNmdpQ3byVN78OHbbuSSGuk9ai5TZy0mifhAB2CmgH88WfFeSfmGIjaUo45EFYDbbveMN8dtlE01f/z+dR8lWL71+/DCDBg4D/0GsariHfeMD2ifhVOEkDXziyItWxT0F2m866vrQU3+Nrdvg3peOFVvZz9XoQcHOWfjqUAhXfxlI1DBc="
  # STRIPE_KEY_TEST
  - secure: "Uo/mjlJEs+m06zO/tJ/2Hia540B8DFYbX4X4h02Qs8yORVljmP55E60fU57zBPuCO9Wxl+J7XsHm48HHRljcB4M7v2dniNOKiDjVH/MDjTdpGUb5qAbYGYoXHcDcDVTmCu2kfDLSQ+H0tALSWwAvw1aIf6xHdk7d2GY+icvWyevCloXwFYhFeXJwQap4WSa9Wnoulp5gWaiEVBqSgGruzsqH97UvhwMp59EQphlMKgedHMEGeMA+oE9UGKOsPWIaKCjcWxvwRt/QUSfRF0FkWWpaFhZ72i415ijF9bGv5DdX05tp/RQ4u8QRHYRbyTet4DQiUJ2ly59y1up135j9uzwOmGFcVVK2Xy4gowyHHQU1Xx8EFONjxEIGbiqwmUP0skQIKtx3DJWf9/mRDJWCwNb7p59ZHgWokSADOv7r9DiP1YvO8vWKJVWN9yNgZhkIUwVfqImZbfoXMQ9Mvzisr1Oj3XfKuPyF8yBAMRrwmYEkgR6qhcEyUj6JpaTPvGKAKMoiNaM60VXe0XNUZD0GCUZEhJMK1q8pCmpg9CRNObtzzMktZq2+Bl1x5vEmixnFh5+iRp/UubI+R2DcgxEuIcP7f8o9sl3v1XeLmeQ8eNvaUvOYz/S4ESTiyImxjKCZBjL/Sux/t371kHPFEXscIVbDaTocILPIL2mZ1qAlVG0="
addons:
  apt:
    packages:
    - docker-ce

before_install:
  - sudo apt-get install -y -q netcat

  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt-get update
  - sudo apt-get -y install docker-ce
  - docker --version

  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - cp .travis.env .env
  - sudo sed -i -e 's/AWS_BUCKET_NAME=TRAVIS/AWS_BUCKET_NAME='${AWS_BUCKET_NAME}'/' .env
  - sudo sed -i -e 's/AWS_ACCESS_KEY_ID=TRAVIS/AWS_ACCESS_KEY_ID='${AWS_ACCESS_KEY_ID}'/' .env
  - sudo sed -i -e 's/AWS_SECRET_ACCESS_KEY=TRAVIS/AWS_SECRET_ACCESS_KEY='${AWS_SECRET_ACCESS_KEY}'/' .env
  - sudo sed -i -e 's/AWS_REGION=TRAVIS/AWS_REGION='${AWS_REGION}'/' .env
  - sudo sed -i -e 's+ETH_NODE_URL=TRAVIS+ETH_NODE_URL='${ETH_NODE_URL}'+' .env
  - sudo sed -i -e 's+STRIPE_KEY_TEST=TRAVIS+STRIPE_KEY_TEST='${STRIPE_KEY_TEST}'+' .env
  - sudo sed -i -e 's+MAIN_WALLET_ADDRESS=TRAVIS+MAIN_WALLET_ADDRESS='${MAIN_WALLET_ADDRESS}'+' .env
  - sudo sed -i -e 's+MAIN_WALLET_PRIVATE_KEY=TRAVIS+MAIN_WALLET_PRIVATE_KEY='${MAIN_WALLET_PRIVATE_KEY}'+' .env
  - docker-compose --version
  - rm -rf ./data
  - docker-compose up --build -d

install: true

script:
  - docker-compose exec app go test ./... -p 1
